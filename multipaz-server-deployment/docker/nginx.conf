# Multipaz Server Bundle - nginx reverse proxy configuration
# Routes requests by path prefix to individual services

worker_processes 1;
error_log /var/log/nginx/error.log warn;
pid /run/nginx/nginx.pid;

events {
    worker_connections 256;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent"';
    access_log /var/log/nginx/access.log main;

    sendfile on;
    keepalive_timeout 65;

    # Upstream definitions for each service
    upstream records {
        server 127.0.0.1:8004;
    }

    upstream csa {
        server 127.0.0.1:8005;
    }

    upstream verifier {
        server 127.0.0.1:8006;
    }

    upstream openid4vci {
        server 127.0.0.1:8007;
    }

    upstream backend {
        server 127.0.0.1:8008;
    }

    server {
        listen 8000;
        server_name _;

        # Increase buffer sizes for large JWT tokens
        proxy_buffer_size 128k;
        proxy_buffers 4 256k;
        proxy_busy_buffers_size 256k;

        # Common proxy settings
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Well-known file remap
        location = /.well-known/oauth-authorization-server/openid4vci {
            proxy_pass http://openid4vci/.well-known/oauth-authorization-server;
        }

        location = /.well-known/openid-credential-issuer/openid4vci {
            proxy_pass http://openid4vci/.well-known/openid-credential-issuer;
        }

        location = /.well-known/assetlinks.json {
            proxy_pass http://backend/.well-known/assetlinks.json;
        }

        location = /.well-known/apple-app-site-association {
            proxy_pass http://backend/.well-known/apple-app-site-association;
        }

        # TODO: going forward, we do not want to expose root pages of individual services,
        # as these should be focused on testing and not necessarily looking good and integrated.
        # Services should be mostly about RPCs and user-facing pages should be supplied by the
        # front-end.

        # Records server (System of Record)
        location /records/ {
            proxy_pass http://records/;
        }
        location = /records {
            return 302 /records/;
        }

        # CSA server (Cloud Secure Area)
        location /csa/ {
            proxy_pass http://csa/;
        }
        location = /csa {
            return 302 /csa/;
        }

        # Verifier server
        location /verifier/ {
            proxy_pass http://verifier/;
        }
        location = /verifier {
            return 302 /verifier/;
        }

        # OpenID4VCI server (Issuer)
        location /openid4vci/ {
            proxy_pass http://openid4vci/;
        }
        location = /openid4vci {
            return 302 /openid4vci/;
        }

        # Backend server
        location /backend/ {
            proxy_pass http://backend/;
        }
        location = /backend {
            return 302 /backend/;
        }

        # Root - serve the web frontend
        location / {
            root /app/web;
            index index.html;
            try_files $uri $uri/ /index.html;
        }

        # Health check endpoint
        location /health {
            default_type application/json;
            return 200 '{"status":"ok"}';
        }
    }
}
